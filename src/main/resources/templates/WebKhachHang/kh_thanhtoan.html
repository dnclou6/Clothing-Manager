<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Thanh to√°n - ACV 360</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="index.html">ACV 360</a>
    </div>
</nav>

<div class="container my-4">
    <h2>Thanh to√°n</h2>
    <form id="checkoutForm">
        <div class="mb-3">
            <label for="fullname" class="form-label">H·ªç v√† t√™n</label>
            <input type="text" class="form-control" id="fullname" required>
        </div>
        <div class="mb-3">
            <label for="address" class="form-label">ƒê·ªãa ch·ªâ nh·∫≠n h√†ng</label>
            <input type="text" class="form-control" id="address" required>
        </div>
        <div class="mb-3">
            <label for="phone" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
            <input type="tel" class="form-control" id="phone" required>
        </div>

        <h5>Ph∆∞∆°ng th·ª©c thanh to√°n</h5>
        <select class="form-select" id="paymentMethod" required>
            <option value="COD">Thanh to√°n khi nh·∫≠n h√†ng (COD)</option>
            <option value="VNPAY">V√≠ ƒëi·ªán t·ª≠ VNPAY</option>
            <option value="CARD">Th·∫ª ng√¢n h√†ng</option>
        </select>

        <h5 class="mt-3">ƒê∆°n v·ªã v·∫≠n chuy·ªÉn</h5>
        <select class="form-select" id="shippingMethod" required onchange="updateTotal()">
            <option value="GHN" data-price="30000">Giao H√†ng Nhanh - 30.000 VNƒê</option>
            <option value="GHTK" data-price="25000">Giao H√†ng Ti·∫øt Ki·ªám - 25.000 VNƒê</option>
            <option value="VNPost" data-price="20000">VNPost - 20.000 VNƒê</option>
        </select>

        <h5 class="mt-3">M√£ gi·∫£m gi√°</h5>
        <div class="input-group">
            <input type="text" class="form-control" id="discountCode" placeholder="Nh·∫≠p m√£ gi·∫£m gi√°">
            <button type="button" class="btn btn-primary" onclick="applyDiscount()">√Åp d·ª•ng</button>
        </div>
        <p id="discountMessage" class="text-success mt-2"></p>

        <h4 class="mt-3">T·ªïng ti·ªÅn: <span id="totalPrice">0</span> VNƒê</h4>

        <!-- N√∫t quay l·∫°i gi·ªè h√†ng -->
        <button type="button" class="btn btn-secondary mt-3" onclick="goToCart()">üõí Quay l·∫°i gi·ªè h√†ng</button>
        <button type="submit" class="btn btn-success mt-3">ƒê·∫∑t h√†ng</button>
    </form>
</div>

<script>
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    let discountValue = 0;
    const validDiscounts = { "GIAM50": 50000, "SALE20": 20000 };

    document.addEventListener("DOMContentLoaded", function() {
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c!');
            window.location.href = 'login.html';
        } else {
            document.getElementById('fullname').value = currentUser.fullname || '';
            document.getElementById('address').value = currentUser.address || '';
            document.getElementById('phone').value = currentUser.phone || '';
        }
        updateTotal();
    });

    function updateTotal() {
        let total = cart.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);
        let shippingFee = parseInt(document.getElementById('shippingMethod').selectedOptions[0].dataset.price);
        let finalTotal = total + shippingFee - discountValue;

        document.getElementById('totalPrice').textContent = finalTotal.toLocaleString();
    }

    function applyDiscount() {
        let code = document.getElementById('discountCode').value.trim();
        if (validDiscounts[code]) {
            discountValue = validDiscounts[code];
            document.getElementById('discountMessage').textContent = `M√£ gi·∫£m gi√° √°p d·ª•ng th√†nh c√¥ng! Gi·∫£m ${discountValue.toLocaleString()} VNƒê.`;
        } else {
            discountValue = 0;
            document.getElementById('discountMessage').textContent = 'M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá.';
        }
        updateTotal();
    }

    function goToCart() {
        window.location.href = 'giohang.html';
    }

    document.getElementById('checkoutForm').addEventListener('submit', function(e) {
        e.preventDefault();

        if (cart.length === 0) {
            alert('Gi·ªè h√†ng tr·ªëng!');
            return;
        }

        const order = {
            id: 'DH' + new Date().getTime(),
            fullname: document.getElementById('fullname').value,
            address: document.getElementById('address').value,
            phone: document.getElementById('phone').value,
            paymentMethod: document.getElementById('paymentMethod').value,
            shippingMethod: document.getElementById('shippingMethod').value,
            cart: cart,
            discount: discountValue,
            total: parseInt(document.getElementById('totalPrice').textContent.replace(/\D/g, '')),
            status: 'Ch·ªù x√°c nh·∫≠n',
            date: new Date().toLocaleString()
        };

        let orders = JSON.parse(localStorage.getItem('orders')) || [];
        orders.push(order);
        localStorage.setItem('orders', JSON.stringify(orders));
        localStorage.removeItem('cart');

        alert('ƒê·∫∑t h√†ng th√†nh c√¥ng! ƒê∆°n h√†ng ƒëang ch·ªù x√°c nh·∫≠n.');
        window.location.href = 'donhang.html';
    });
</script>

</body>
</html>
