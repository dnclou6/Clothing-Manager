<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thêm Chi Tiết Sản Phẩm</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #eef2f7;
            color: #333;
        }
        .container {
            max-width: 1300px;
        }
        .page-title {
            color: #343a40;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        .card {
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        .card-header {
            background-color: #ffffff;
            border-bottom: 1px solid #e9ecef;
            padding: 1rem 1.5rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-header i {
            margin-right: 0.5rem;
        }
        .card-body {
            padding: 1.5rem;
        }
        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #495057;
        }
        .form-control, .form-select,
        .select2-container .select2-selection--single,
        .select2-container--default .select2-selection--multiple {
            border-radius: 0.375rem;
            border: 1px solid #ced4da;
            min-height: calc(1.5em + 1.2rem + 2px);
            padding-top: 0.6rem;
            padding-bottom: 0.6rem;
            font-size: 1rem;
            line-height: 1.5;
            background-color: #fff;
        }
        .form-control, .form-select {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        .select2-container .select2-selection--single {
            padding-left: 1rem;
            padding-right: 2.5rem;
        }
        .select2-container .select2-selection--single .select2-selection__rendered {
            padding-left: 0;
            padding-right: 0;
            line-height: 1.5;
            color: #212529;
        }
        .select2-container--default .select2-selection--single .select2-selection__placeholder {
            color: #6c757d;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: calc(1.5em + 1.2rem + 2px - 2px);
            right: 0.75rem;
        }
        .select2-container--default .select2-selection--multiple {
            padding: 0.375rem 0.75rem;
            min-height: calc(1.5em + 1.2rem + 2px);
        }
        .form-control:focus, .form-select:focus,
        .select2-container--focus .select2-selection--single,
        .select2-container--focus .select2-selection--multiple {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            outline: 0;
        }
        .select2-dropdown {
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .select2-container--default .select2-search--dropdown .select2-search__field {
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            padding: 0.6rem 1rem;
        }
        .select2-results__option--highlighted[aria-selected] {
            background-color: #0d6efd;
            color: white;
        }
        .btn {
            border-radius: 0.375rem;
            padding: 0.6rem 1.2rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .btn i {
            margin-right: 0.5rem;
        }
        .btn-primary { background-color: #0d6efd; border-color: #0d6efd; }
        .btn-primary:hover { background-color: #0b5ed7; border-color: #0a58ca; }
        .btn-success { background-color: #198754; border-color: #198754; }
        .btn-success:hover { background-color: #157347; border-color: #146c43; }
        .btn-warning { background-color: #ffc107; border-color: #ffc107; color: #333; }
        .btn-warning:hover { background-color: #ffca2c; border-color: #ffc720; }
        .btn-danger { background-color: #dc3545; border-color: #dc3545; }
        .btn-danger:hover { background-color: #bb2d3b; border-color: #b02a37; }
        .btn-secondary { background-color: #6c757d; border-color: #6c757d; }
        .btn-secondary:hover { background-color: #5c636a; border-color: #565e64; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .table {
            margin-bottom: 0;
            border-color: #e9ecef;
            vertical-align: middle;
        }
        .table thead {
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 500;
            border-bottom-width: 2px;
        }
        .table th, .table td {
            padding: 1rem;
            border-top: 1px solid #e9ecef;
        }
        .table-hover > tbody > tr:hover {
            background-color: rgba(0, 0, 0, 0.04);
        }
        .modal-header {
            background-color: #0d6efd;
            color: white;
            border-bottom: none;
        }
        .modal-header .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        .modal-content {
            border-radius: 0.75rem;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .modal-footer {
            border-top: 1px solid #e9ecef;
            background-color: #f8f9fa;
            border-radius: 0 0 0.75rem 0.75rem;
        }
        .action-buttons .btn {
            margin-right: 5px;
        }
        .action-buttons .btn:last-child {
            margin-right: 0;
        }
        .table-responsive {
            border-radius: 0 0 0.75rem 0.75rem;
        }
        .breadcrumb {
            background-color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
        }
        .breadcrumb-item a {
            color: #0d6efd;
            text-decoration: none;
        }
        .breadcrumb-item.active {
            color: #6c757d;
        }
        .variation-block {
            background-color: #f8f9fa;
            margin-left: 0;
            margin-right: 0;
            padding: 1rem;
            border-radius: 0.375rem;
        }
        .custom-file-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            background-color: #fff;
            transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
            height: calc(1.5em + 1.2rem + 2px);
            overflow: hidden;
        }
        .custom-file-input-wrapper:focus-within {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .custom-file-input-wrapper input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2;
        }
        .custom-file-input-button {
            background-color: #0d6efd;
            color: white;
            padding: 0.6rem 1rem;
            border-right: 1px solid #ced4da;
            font-weight: 500;
            transition: background-color .2s ease-in-out;
            z-index: 1;
        }
        .custom-file-input-button:hover {
            background-color: #0b5ed7;
        }
        .custom-file-input-label {
            flex-grow: 1;
            padding: 0.6rem 1rem;
            color: #495057;
            font-size: 1rem;
            line-height: 1.5;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background-color: #f8f9fa;
        }
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .image-preview {
            position: relative;
            width: 100px;
            height: 100px;
        }
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.25rem;
            border: 1px solid #ced4da;
        }
        .image-preview .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            font-size: 12px;
        }
        .quick-add-btn {
            margin-left: 0.5rem;
            padding: 0.4rem 0.8rem;
            font-size: 0.875rem;
        }
        .batch-actions {
            display: flex;
            gap: 10px;
        }
        .select-all-checkbox {
            width: 18px;
            height: 18px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4 justify-content-between fixed-top">
    <a class="navbar-brand fw-bold text-primary" href="#">
        <i class="fas fa-store-alt me-2"></i>ACV Admin
    </a>
    <div class="d-flex align-items-center">
        <div th:replace="~{fragments/account_dropdown :: accountDropdown(user=${user})}"></div>
    </div>
</nav>

<div class="d-flex">
    <div th:replace="~{fragments/admin_sidebar :: sidebar}"></div>
    <div class="content">
        <h2 class="mb-4 text-center page-title">THÊM CHI TIẾT SẢN PHẨM</h2>

        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/acvstore/products}"><i class="fas fa-list me-1"></i>Danh sách sản phẩm</a></li>
                <li class="breadcrumb-item active" aria-current="page"><i class="fas fa-plus-circle me-1"></i>Thêm chi tiết</li>
            </ol>
        </nav>

        <div class="card mb-4">
            <div class="card-header">
                <span><i class="fas fa-box-open me-2"></i> Chọn Sản Phẩm & Thuộc Tính Cơ Bản</span>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-4 align-items-end">
                    <div class="col-md-12">
                        <label for="productSelect" class="form-label">Sản phẩm</label>
                        <select class="form-select" id="productSelect" name="productId" th:disabled="${selectedProductId != null}">
                            <option value="">Chọn sản phẩm...</option>
                            <option th:each="p : ${products}" th:value="${p.id}" th:text="${p.name}" th:selected="${selectedProductId != null and p.id == selectedProductId}"></option>
                        </select>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="originSelect" class="form-label">Thương hiệu</label>
                        <div class="d-flex align-items-center">
                            <select class="form-select" id="originSelect" name="originId">
                                <option value="">Chọn thương hiệu...</option>
                                <option th:each="o : ${origins}" th:value="${o.id}" th:text="${o.name}"></option>
                            </select>
                            <button type="button" class="btn btn-success btn-sm quick-add-btn" data-bs-toggle="modal" data-bs-target="#quickAddModal" data-entity="origin" title="Thêm nhanh thương hiệu">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label for="materialSelect" class="form-label">Chất liệu</label>
                        <div class="d-flex align-items-center">
                            <select class="form-select" id="materialSelect" name="materialId">
                                <option value="">Chọn chất liệu...</option>
                                <option th:each="m : ${materials}" th:value="${m.id}" th:text="${m.name}"></option>
                            </select>
                            <button type="button" class="btn btn-success btn-sm quick-add-btn" data-bs-toggle="modal" data-bs-target="#quickAddModal" data-entity="material" title="Thêm nhanh chất liệu">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label for="styleSelect" class="form-label">Kiểu dáng</label>
                        <div class="d-flex align-items-center">
                            <select class="form-select" id="styleSelect" name="styleId">
                                <option value="">Chọn kiểu dáng...</option>
                                <option th:each="st : ${styles}" th:value="${st.id}" th:text="${st.name}"></option>
                            </select>
                            <button type="button" class="btn btn-success btn-sm quick-add-btn" data-bs-toggle="modal" data-bs-target="#quickAddModal" data-entity="style" title="Thêm nhanh kiểu dáng">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-palette me-2"></i> Chọn Màu Sắc & Kích Cỡ
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="sizeSelect" class="form-label">Kích cỡ</label>
                        <div class="d-flex align-items-center">
                            <select class="form-select" id="sizeSelect" name="sizes" multiple>
                                <option th:each="s : ${sizes}" th:value="${s.id}" th:text="${s.name}"></option>
                            </select>
                            <button type="button" class="btn btn-success btn-sm quick-add-btn" data-bs-toggle="modal" data-bs-target="#quickAddModal" data-entity="size" title="Thêm nhanh kích cỡ">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="colorSelect" class="form-label">Màu sắc</label>
                        <div class="d-flex align-items-center">
                            <select class="form-select" id="colorSelect" name="colors" multiple>
                                <option th:each="c : ${colors}" th:value="${c.id}" th:text="${c.name}"></option>
                            </select>
                            <button type="button" class="btn btn-success btn-sm quick-add-btn" data-bs-toggle="modal" data-bs-target="#quickAddModal" data-entity="color" title="Thêm nhanh màu sắc">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4" id="variationsCard" style="display: none;">
            <div class="card-header">
                <i class="fas fa-random me-2"></i> Tạo Các Biến Thể Chi Tiết
            </div>
            <div class="card-body">
                <form th:action="@{/acvstore/product-details/save-batch}" method="post" enctype="multipart/form-data" id="batchForm">
                    <input type="hidden" name="productId" id="hiddenProductId"/>
                    <input type="hidden" name="originId" id="hiddenOriginId"/>
                    <input type="hidden" name="materialId" id="hiddenMaterialId"/>
                    <input type="hidden" name="styleId" id="hiddenStyleId"/>

                    <div id="variationsContainer" class="mt-2">
                    </div>

                    <div class="col-12 mt-4 text-end" id="submitButtonContainer">
                        <button type="submit" class="btn btn-success" onclick="return validateForm()">
                            <i class="fas fa-save me-2"></i> Lưu Tất Cả Chi Tiết
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span><i class="fas fa-list me-2"></i> Danh sách Chi Tiết Sản Phẩm Hiện Có</span>
                <div class="batch-actions">
                    <button class="btn btn-warning btn-sm" id="batchEditBtn" disabled title="Sửa hàng loạt">
                        <i class="fas fa-edit"></i> Sửa hàng loạt
                    </button>
                    <button class="btn btn-danger btn-sm" id="batchDeleteBtn" disabled title="Xóa hàng loạt">
                        <i class="fas fa-trash-alt"></i> Xóa hàng loạt
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" class="select-all-checkbox"></th>
                        <th>#</th>
                        <th>Ảnh</th>
                        <th>Sản phẩm</th>
                        <th>Màu</th>
                        <th>Size</th>
                        <th>Giá</th>
                        <th>Số lượng</th>
                        <th>Tình trạng</th>
                        <th>Ngày tạo</th>
                        <th class="text-center">Hành động</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="pd, stats : ${productDetailList}">
                        <td><input type="checkbox" class="row-checkbox" th:value="${pd.id}"></td>
                        <td th:text="${stats.count}"></td>
                        <td>
                            <div th:if="${pd.images != null and !pd.images.isEmpty()}">
                                <div th:if="${pd.images.size() == 1}">
                                    <img th:src="@{'/Uploads/' + ${pd.images[0].imageUrl}}" alt="Ảnh" class="d-block" style="width: 60px; height: 60px; object-fit: cover;"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                                    <span style="display:none;" class="text-danger small">Ảnh lỗi</span>
                                </div>
                                <div th:if="${pd.images.size() > 1}">
                                    <div th:id="'carousel-' + ${pd.id}" class="carousel slide" data-bs-ride="carousel" data-bs-interval="2000" data-bs-wrap="true" style="width: 60px; height: 60px;">
                                        <div class="carousel-inner">
                                            <div th:each="img, imgStat : ${pd.images}" class="carousel-item" th:classappend="${imgStat.first} ? 'active' : ''">
                                                <img th:src="@{'/Uploads/' + ${img.imageUrl}}" alt="Ảnh" class="d-block w-100 h-100" style="object-fit: cover;"
                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                                                <span style="display:none;" class="text-danger small">Ảnh lỗi</span>
                                            </div>
                                        </div>
                                        <button class="carousel-control-prev" type="button" th:attr="data-bs-target='#carousel-' + ${pd.id}" data-bs-slide="prev">
                                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                            <span class="visually-hidden">Previous</span>
                                        </button>
                                        <button class="carousel-control-next" type="button" th:attr="data-bs-target='#carousel-' + ${pd.id}" data-bs-slide="next">
                                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                            <span class="visually-hidden">Next</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <span th:unless="${pd.images != null and !pd.images.isEmpty()}" class="text-muted">Không có</span>
                        </td>
                        <td th:text="${pd.product?.name ?: 'N/A'}"></td>
                        <td th:text="${pd.color?.name ?: 'N/A'}"></td>
                        <td th:text="${pd.size?.name ?: 'N/A'}"></td>
                        <td th:text="${#numbers.formatDecimal(pd.price, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                        <td th:text="${pd.stockQuantity}"></td>
                        <td>
                            <span th:text="${pd.getStockStatus()}"
                                  th:classappend="${pd.stockQuantity > 10 ? 'badge bg-success' : (pd.stockQuantity > 0 ? 'badge bg-warning text-dark' : 'badge bg-danger')}">
                            </span>
                        </td>
                        <td th:text="${pd.createdAt != null ? #temporals.format(pd.createdAt, 'dd/MM/yyyy HH:mm') : 'N/A'}"></td>
                        <td class="text-center action-buttons">
                            <button class="btn btn-warning btn-sm edit-btn" th:data-id="${pd.id}" data-bs-toggle="modal" data-bs-target="#editProductDetailModal" title="Sửa">
                                <i class="fas fa-edit"></i>
                            </button>
                            <form th:action="@{'/acvstore/product-details/delete/' + ${pd.id}}" method="post" style="display: inline;">
                                <input type="hidden" name="productId" th:value="${selectedProductId}" />
                                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Bạn có chắc muốn xóa chi tiết này?');" title="Xóa">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    <tr th:if="${productDetailList == null or productDetailList.isEmpty()}">
                        <td colspan="11" class="text-center text-muted py-5">Chưa có chi tiết sản phẩm nào được thêm.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Thêm Nhanh Thuộc Tính -->
    <div class="modal fade" id="quickAddModal" tabindex="-1" aria-labelledby="quickAddModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="quickAddModalLabel">Thêm Nhanh Thuộc Tính</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="quickAddEntity">
                    <div class="mb-3">
                        <label for="quickAddName" class="form-label">Tên thuộc tính</label>
                        <input type="text" class="form-control" id="quickAddName" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Đóng
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveQuickAdd()">
                        <i class="fas fa-save"></i> Lưu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Sửa Chi Tiết Sản Phẩm -->
    <div class="modal fade" id="editProductDetailModal" tabindex="-1" aria-labelledby="editProductDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editProductDetailModalLabel"><i class="fas fa-edit me-2"></i>Sửa Chi Tiết Sản Phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editProductDetailForm" enctype="multipart/form-data">
                        <input type="hidden" id="editId" name="id"/>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="editProduct" class="form-label">Sản phẩm</label>
                                <select class="form-select" id="editProduct" disabled>
                                    <option value="">Chọn sản phẩm...</option>
                                    <option th:each="p : ${allProducts}" th:value="${p.id}" th:text="${p.name}"></option>
                                </select>
                                <input type="hidden" id="editProductHidden" name="productId" />
                            </div>
                            <div class="col-md-6">
                                <label for="editColor" class="form-label">Màu sắc</label>
                                <select class="form-select" id="editColor" name="colorId" required>
                                    <option value="">Chọn màu...</option>
                                    <option th:each="c : ${allColors}" th:value="${c.id}" th:text="${c.name}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="editSize" class="form-label">Kích cỡ</label>
                                <select class="form-select" id="editSize" name="sizeId" required>
                                    <option value="">Chọn kích cỡ...</option>
                                    <option th:each="s : ${allSizes}" th:value="${s.id}" th:text="${s.name}"></option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editOrigin" class="form-label">Thương hiệu</label>
                                <select class="form-select" id="editOrigin" name="originId" required>
                                    <option value="">Chọn thương hiệu...</option>
                                    <option th:each="o : ${allOrigins}" th:value="${o.id}" th:text="${o.name}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="editMaterial" class="form-label">Chất liệu</label>
                                <select class="form-select" id="editMaterial" name="materialId" required>
                                    <option value="">Chọn chất liệu...</option>
                                    <option th:each="m : ${allMaterials}" th:value="${m.id}" th:text="${m.name}"></option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="editStyle" class="form-label">Kiểu dáng</label>
                                <select class="form-select" id="editStyle" name="styleId" required>
                                    <option value="">Chọn kiểu dáng...</option>
                                    <option th:each="st : ${allStyles}" th:value="${st.id}" th:text="${st.name}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="editPrice" class="form-label">Giá bán</label>
                                <input type="number" class="form-control" id="editPrice" name="price" step="1000" min="0" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editStockQuantity" class="form-label">Số lượng tồn</label>
                                <input type="number" class="form-control" id="editStockQuantity" name="stockQuantity" min="0" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editImageFiles" class="form-label">Ảnh mới (chọn để thêm hoặc thay thế, tối đa 3 ảnh)</label>
                            <div class="custom-file-input-wrapper">
                                <span class="custom-file-input-button"><i class="fas fa-upload"></i> Chọn ảnh</span>
                                <span class="custom-file-input-label" data-placeholder="Chưa có ảnh nào được chọn">Chưa có ảnh nào được chọn</span>
                                <input type="file" id="editImageFiles" name="imageFiles" multiple accept="image/*" onchange="updateFileInputLabel(this)">
                            </div>
                            <div id="editImagePreview" class="image-preview-container"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ảnh hiện tại</label>
                            <div id="currentImages" class="d-flex flex-wrap gap-2 border p-2 rounded bg-light" style="min-height: 100px;">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-2"></i>Đóng</button>
                            <button class="btn btn-primary" type="submit"><i class="fas fa-save me-2"></i>Lưu thay đổi</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Sửa Hàng Loạt -->
    <div class="modal fade" id="batchEditModal" tabindex="-1" aria-labelledby="batchEditModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="batchEditModalLabel"><i class="fas fa-edit me-2"></i>Sửa Hàng Loạt Chi Tiết Sản Phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="batchEditForm" enctype="multipart/form-data">
                        <input type="hidden" id="batchEditIds" name="ids"/>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="batchEditOrigin" class="form-label">Thương hiệu</label>
                                <select class="form-select" id="batchEditOrigin" name="originId">
                                    <option value="">Không thay đổi</option>
                                    <option th:each="o : ${allOrigins}" th:value="${o.id}" th:text="${o.name}"></option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="batchEditMaterial" class="form-label">Chất liệu</label>
                                <select class="form-select" id="batchEditMaterial" name="materialId">
                                    <option value="">Không thay đổi</option>
                                    <option th:each="m : ${allMaterials}" th:value="${m.id}" th:text="${m.name}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="batchEditStyle" class="form-label">Kiểu dáng</label>
                                <select class="form-select" id="batchEditStyle" name="styleId">
                                    <option value="">Không thay đổi</option>
                                    <option th:each="st : ${allStyles}" th:value="${st.id}" th:text="${st.name}"></option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="batchEditPrice" class="form-label">Giá bán</label>
                                <input type="number" class="form-control" id="batchEditPrice" name="price" step="1000" min="0" placeholder="Không thay đổi">
                            </div>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label for="batchEditStockQuantity" class="form-label">Số lượng tồn</label>
                                <input type="number" class="form-control" id="batchEditStockQuantity" name="stockQuantity" min="0" placeholder="Không thay đổi">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-2"></i>Đóng</button>
                            <button class="btn btn-primary" type="submit"><i class="fas fa-save me-2"></i>Lưu thay đổi</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        $('#productSelect').select2({ placeholder: "Chọn sản phẩm...", allowClear: true, width: '100%' });
        $('#originSelect').select2({ placeholder: "Chọn thương hiệu...", allowClear: true, width: '100%' });
        $('#materialSelect').select2({ placeholder: "Chọn chất liệu...", allowClear: true, width: '100%' });
        $('#styleSelect').select2({ placeholder: "Chọn kiểu dáng...", allowClear: true, width: '100%' });
        $('#sizeSelect').select2({ placeholder: "Chọn hoặc tìm kích cỡ...", allowClear: true, width: '100%', tags: false });
        $('#colorSelect').select2({ placeholder: "Chọn hoặc tìm màu sắc...", allowClear: true, width: '100%', tags: false });

        $('#editProduct').select2({ dropdownParent: $('#editProductDetailModal .modal-body'), placeholder: "Chọn sản phẩm...", width: '100%' });
        $('#editColor').select2({ dropdownParent: $('#editProductDetailModal .modal-body'), placeholder: "Chọn màu...", width: '100%' });
        $('#editSize').select2({ dropdownParent: $('#editProductDetailModal .modal-body'), placeholder: "Chọn kích cỡ...", width: '100%' });
        $('#editOrigin').select2({ dropdownParent: $('#editProductDetailModal .modal-body'), placeholder: "Chọn thương hiệu...", width: '100%' });
        $('#editMaterial').select2({ dropdownParent: $('#editProductDetailModal .modal-body'), placeholder: "Chọn chất liệu...", width: '100%' });
        $('#editStyle').select2({ dropdownParent: $('#editProductDetailModal .modal-body'), placeholder: "Chọn kiểu dáng...", width: '100%' });

        $('#batchEditOrigin').select2({ dropdownParent: $('#batchEditModal .modal-body'), placeholder: "Không thay đổi", width: '100%' });
        $('#batchEditMaterial').select2({ dropdownParent: $('#batchEditModal .modal-body'), placeholder: "Không thay đổi", width: '100%' });
        $('#batchEditStyle').select2({ dropdownParent: $('#batchEditModal .modal-body'), placeholder: "Không thay đổi", width: '100%' });

        // Xử lý checkbox chọn tất cả
        $('#selectAll').on('change', function() {
            $('.row-checkbox').prop('checked', this.checked);
            updateBatchButtons();
        });

        // Xử lý checkbox từng dòng
        $('.row-checkbox').on('change', updateBatchButtons);

        // Xử lý nút sửa hàng loạt
        $('#batchEditBtn').on('click', function() {
            const selectedIds = getSelectedIds();
            if (selectedIds.length > 0) {
                $('#batchEditIds').val(selectedIds.join(','));
                $('#batchEditModal').modal('show');
            }
        });

        // Xử lý nút xóa hàng loạt
        $('#batchDeleteBtn').on('click', function() {
            const selectedIds = getSelectedIds();
            if (selectedIds.length > 0 && confirm('Bạn có chắc muốn xóa các chi tiết sản phẩm đã chọn?')) {
                $.ajax({
                    url: '/acvstore/product-details/batch-delete',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ ids: selectedIds }),
                    success: function(response) {
                        alert('Xóa thành công!');
                        location.reload();
                    },
                    error: function(xhr) {
                        alert('Lỗi khi xóa: ' + (xhr.responseText || xhr.statusText));
                    }
                });
            }
        });

        // Xử lý form sửa hàng loạt
        $('#batchEditForm').on('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            $.ajax({
                url: '/acvstore/product-details/batch-update',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    $('#batchEditModal').modal('hide');
                    alert('Cập nhật thành công!');
                    location.reload();
                },
                error: function(xhr) {
                    alert('Lỗi khi cập nhật: ' + (xhr.responseText || xhr.statusText));
                }
            });
        });

        $(document).on('click', '.edit-btn', function() {
            const productDetailId = $(this).data('id');
            loadProductDetailData(productDetailId);
        });

        $('#editProductDetailForm').on('submit', function(e) {
            e.preventDefault();
            updateProductDetail();
        });

        $('#productSelect, #originSelect, #materialSelect, #styleSelect, #colorSelect, #sizeSelect').on('change', generateVariations);

        $('#editProductDetailModal').on('hidden.bs.modal', function () {
            const input = document.getElementById('editImageFiles');
            if(input) {
                input.value = '';
                updateFileInputLabel(input);
                $('#editImagePreview').empty();
            }
        });

        $('#batchEditModal').on('hidden.bs.modal', function () {
            $('#batchEditForm')[0].reset();
            $('#batchEditOrigin').val('').trigger('change');
            $('#batchEditMaterial').val('').trigger('change');
            $('#batchEditStyle').val('').trigger('change');
        });

        $('.quick-add-btn').on('click', function() {
            const entity = $(this).data('entity');
            $('#quickAddEntity').val(entity);
            $('#quickAddName').val('');
            $('#quickAddModalLabel').text('Thêm Nhanh ' + capitalize(entity));
        });

        $('.carousel').each(function() {
            const $carousel = $(this);
            if ($carousel.find('.carousel-item').length > 1) {
                $carousel.carousel({
                    interval: 3000,
                    wrap: true,
                    ride: 'carousel'
                });
            }
        });
    });

    function updateBatchButtons() {
        const selectedCount = $('.row-checkbox:checked').length;
        $('#batchEditBtn').prop('disabled', selectedCount === 0);
        $('#batchDeleteBtn').prop('disabled', selectedCount === 0);
        $('#selectAll').prop('checked', selectedCount > 0 && selectedCount === $('.row-checkbox').length);
    }

    function getSelectedIds() {
        return $('.row-checkbox:checked').map(function() {
            return $(this).val();
        }).get();
    }

    function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function saveQuickAdd() {
        const entity = $('#quickAddEntity').val();
        const name = $('#quickAddName').val().trim();
        if (!name) {
            alert('Vui lòng nhập tên thuộc tính.');
            $('#quickAddName').focus();
            return;
        }

        $.ajax({
            url: '/acvstore/product-details/quick-add-' + entity,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ name: name }),
            success: function(response) {
                $('#quickAddModal').modal('hide');
                refreshSelectOptions(entity, response.id, name);
                alert('Thêm ' + capitalize(entity) + ' thành công!');
            },
            error: function(xhr) {
                let errorMessage = xhr.statusText;
                try {
                    const errorResponse = JSON.parse(xhr.responseText);
                    errorMessage = errorResponse.message || xhr.responseText;
                } catch (e) {}
                alert('Lỗi khi thêm ' + capitalize(entity) + ': ' + errorMessage);
            }
        });
    }

    function refreshSelectOptions(entity, newId, newName) {
        const selectId = '#' + entity + 'Select';
        const $select = $(selectId);
        $select.append(new Option(newName, newId, false, true));
        $select.trigger('change');
    }

    function updateFileInputLabel(inputElement) {
        const wrapper = inputElement.closest('.custom-file-input-wrapper');
        if (!wrapper) return;
        const label = wrapper.querySelector('.custom-file-input-label');
        const placeholder = label.getAttribute('data-placeholder') || 'Chưa có tệp nào được chọn';

        if (inputElement.files && inputElement.files.length > 0) {
            if (inputElement.files.length === 1) {
                label.textContent = inputElement.files[0].name;
            } else {
                label.textContent = `${inputElement.files.length} tệp đã được chọn`;
            }
        } else {
            label.textContent = placeholder;
        }

        const previewContainer = inputElement.closest('.mb-3')?.querySelector('.image-preview-container') || document.getElementById('editImagePreview');
        if (previewContainer) {
            previewContainer.innerHTML = '';
            Array.from(inputElement.files).slice(0, 3).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewDiv = document.createElement('div');
                    previewDiv.classList.add('image-preview');
                    previewDiv.innerHTML = `
                        <img src="${e.target.result}" alt="Preview ${index + 1}">
                        <button type="button" class="remove-image" onclick="removeImagePreview(this, '${inputElement.id}')">×</button>
                    `;
                    previewContainer.appendChild(previewDiv);
                };
                reader.readAsDataURL(file);
            });
        }
    }

    function removeImagePreview(button, inputId) {
        const inputElement = document.getElementById(inputId);
        if (!inputElement) return;

        const files = Array.from(inputElement.files);
        const index = Array.from(button.closest('.image-preview-container').children).indexOf(button.parentElement);
        if (index === -1) return;

        const newFiles = files.filter((_, i) => i !== index);
        const dataTransfer = new DataTransfer();
        newFiles.forEach(file => dataTransfer.items.add(file));
        inputElement.files = dataTransfer.files;

        updateFileInputLabel(inputElement);
    }

    function loadProductDetailData(id) {
        $.ajax({
            url: '/acvstore/product-details/edit/' + id,
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                if (!response) {
                    alert("Không nhận được dữ liệu cho chi tiết sản phẩm này.");
                    return;
                }
                $('#editId').val(response.id);
                $('#editPrice').val(response.price);
                $('#editStockQuantity').val(response.stockQuantity);

                $('#editProduct').val(response.productId).trigger('change');
                $('#editProductHidden').val(response.productId);
                $('#editColor').val(response.colorId).trigger('change');
                $('#editSize').val(response.sizeId).trigger('change');
                $('#editOrigin').val(response.originId).trigger('change');
                $('#editMaterial').val(response.materialId).trigger('change');
                $('#editStyle').val(response.styleId).trigger('change');

                const currentImagesDiv = $('#currentImages');
                currentImagesDiv.empty();
                if (response.images && response.images.length > 0) {
                    response.images.forEach(function(image) {
                        const imageHtml = `
                        <div class="position-relative" style="width: 100px;" id="image-container-${image.id}">
                            <img src="/Uploads/${image.imageUrl}" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;"
                                 onerror="this.onerror=null; this.src='https://via.placeholder.com/100?text=Lỗi'; this.alt='Ảnh lỗi';">
                            <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 p-0 m-1" style="line-height: 1; height: 20px; width: 20px;" onclick="deleteImage(${image.id})">×</button>
                        </div>`;
                        currentImagesDiv.append(imageHtml);
                    });
                } else {
                    currentImagesDiv.append('<p class="text-muted mb-0 w-100 text-center">Không có ảnh nào.</p>');
                }
                const fileInput = document.getElementById('editImageFiles');
                if (fileInput) {
                    fileInput.value = '';
                    updateFileInputLabel(fileInput);
                }
            },
            error: function(xhr) {
                alert("Lỗi khi tải dữ liệu chi tiết sản phẩm: " + (xhr.responseText || xhr.statusText));
            }
        });
    }

    function updateProductDetail() {
        const formData = new FormData($('#editProductDetailForm')[0]);
        const id = $('#editId').val();

        const fileInput = document.getElementById('editImageFiles');
        if (fileInput.files.length > 3) {
            alert('Bạn chỉ có thể tải lên tối đa 3 ảnh.');
            return;
        }

        $.ajax({
            url: '/acvstore/product-details/update/' + id,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                $('#editProductDetailModal').modal('hide');
                location.reload();
            },
            error: function(xhr) {
                let errorMessage = xhr.statusText;
                try {
                    const errorResponse = JSON.parse(xhr.responseText);
                    if (errorResponse && errorResponse.message) {
                        errorMessage = errorResponse.message;
                    } else if(xhr.responseText) {
                        errorMessage = xhr.responseText;
                    }
                } catch (e) {}
                alert("Lỗi khi cập nhật chi tiết sản phẩm: " + errorMessage);
            }
        });
    }

    function deleteImage(imageId) {
        if (confirm('Bạn có chắc chắn muốn xóa ảnh này? Hành động này không thể hoàn tác.')) {
            $.ajax({
                url: '/acvstore/product-details/delete-image/' + imageId,
                type: 'POST',
                success: function(response) {
                    $(`#image-container-${imageId}`).remove();
                    alert("Đã xóa ảnh thành công!");
                    if ($('#currentImages').children(':not(p)').length === 0) {
                        $('#currentImages').html('<p class="text-muted mb-0 w-100 text-center">Không có ảnh nào.</p>');
                    }
                },
                error: function(xhr) {
                    alert('Lỗi khi xóa ảnh: ' + (xhr.responseText || xhr.statusText));
                }
            });
        }
    }

    function generateVariations() {
        const productId = $('#productSelect').val();
        const selectedOrigin = $('#originSelect').select2('data')[0];
        const selectedMaterial = $('#materialSelect').select2('data')[0];
        const selectedStyle = $('#styleSelect').select2('data')[0];
        const selectedColors = $('#colorSelect').select2('data').map(option => ({ id: option.id, name: option.text }));
        const selectedSizes = $('#sizeSelect').select2('data').map(option => ({ id: option.id, name: option.text }));

        const variationsContainer = document.getElementById('variationsContainer');
        const variationsCard = document.getElementById('variationsCard');
        variationsContainer.innerHTML = '';

        if (productId && selectedOrigin && selectedMaterial && selectedStyle && selectedColors.length > 0 && selectedSizes.length > 0) {
            $('#hiddenProductId').val(productId);
            $('#hiddenOriginId').val(selectedOrigin.id);
            $('#hiddenMaterialId').val(selectedMaterial.id);
            $('#hiddenStyleId').val(selectedStyle.id);

            let variationIndex = 0;
            selectedColors.forEach(color => {
                const colorGroupDiv = document.createElement('div');
                colorGroupDiv.classList.add('mb-4', 'p-3', 'border', 'rounded', 'variation-block');

                colorGroupDiv.innerHTML = `
                    <h5 class="mb-3">Màu: <span class="fw-bold">${color.name}</span></h5>
                    <div class="mb-3">
                        <label class="form-label">Ảnh cho màu ${color.name} (tối đa 3 ảnh)</label>
                        <div class="custom-file-input-wrapper">
                            <span class="custom-file-input-button"><i class="fas fa-upload"></i> Chọn Ảnh</span>
                            <span class="custom-file-input-label" data-placeholder="Chưa có ảnh nào được chọn">Chưa có ảnh nào được chọn</span>
                            <input type="file" class="variation-file-input" id="image-input-${color.id}" name="variations[${variationIndex}].imageFiles" multiple accept="image/*" onchange="updateFileInputLabel(this)" title="Chọn ảnh cho màu ${color.name}">
                        </div>
                        <div class="image-preview-container" id="preview-${color.id}"></div>
                    </div>
                `;

                const sizesContainer = document.createElement('div');
                selectedSizes.forEach(size => {
                    const variationDiv = document.createElement('div');
                    variationDiv.classList.add('row', 'g-3', 'mb-2', 'align-items-center');
                    variationDiv.innerHTML = `
                        <h6 class="col-12 mb-2 fw-normal">Biến thể: <span class="fw-bold">${color.name} / ${size.name}</span></h6>
                        <input type="hidden" name="variations[${variationIndex}].colorId" value="${color.id}">
                        <input type="hidden" name="variations[${variationIndex}].sizeId" value="${size.id}">
                        <input type="hidden" name="variations[${variationIndex}].productId" value="${productId}">
                        <div class="col-md-6">
                            <label class="form-label visually-hidden">Giá bán</label>
                            <div class="input-group">
                                <span class="input-group-text">₫</span>
                                <input type="number" step="1000" min="0" class="form-control variation-price" name="variations[${variationIndex}].price" required placeholder="Giá bán">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label visually-hidden">Số lượng tồn</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-boxes"></i></span>
                                <input type="number" min="0" class="form-control variation-quantity" name="variations[${variationIndex}].stockQuantity" required placeholder="Số lượng">
                            </div>
                        </div>
                    `;
                    sizesContainer.appendChild(variationDiv);
                    variationIndex++;
                });

                colorGroupDiv.appendChild(sizesContainer);
                variationsContainer.appendChild(colorGroupDiv);
            });

            variationsCard.style.display = 'block';
        } else {
            variationsCard.style.display = 'none';
        }
    }

    function validateForm() {
        const productId = $('#productSelect').val();
        const selectedOrigin = $('#originSelect').select2('data')[0];
        const selectedMaterial = $('#materialSelect').select2('data')[0];
        const selectedStyle = $('#styleSelect').select2('data')[0];
        const selectedColors = $('#colorSelect').select2('data');
        const selectedSizes = $('#sizeSelect').select2('data');

        if (!productId || !selectedOrigin || !selectedMaterial || !selectedStyle || selectedColors.length === 0 || selectedSizes.length === 0) {
            alert('Vui lòng chọn đầy đủ: Sản phẩm, 1 Thương hiệu, 1 Chất liệu, 1 Kiểu dáng, ít nhất 1 Màu sắc và 1 Kích cỡ để tạo biến thể.');
            if (!productId) $('#productSelect').select2('open');
            else if (!selectedOrigin) $('#originSelect').select2('open');
            else if (!selectedMaterial) $('#materialSelect').select2('open');
            else if (!selectedStyle) $('#styleSelect').select2('open');
            else if (selectedColors.length === 0) $('#colorSelect').select2('open');
            else if (selectedSizes.length === 0) $('#sizeSelect').select2('open');
            return false;
        }

        let variationsValid = true;
        $('#variationsContainer .variation-block').each(function(index, colorGroup) {
            const colorName = $(colorGroup).find('h5 span').text();
            const fileInput = $(colorGroup).find('.variation-file-input');
            if (fileInput[0].files.length > 3) {
                alert(`Bạn chỉ có thể tải lên tối đa 3 ảnh cho màu ${colorName}.`);
                fileInput.focus();
                variationsValid = false;
                return false;
            }

            $(colorGroup).find('.row.g-3').each(function(varIndex, variation) {
                const priceInput = $(this).find('.variation-price');
                const quantityInput = $(this).find('.variation-quantity');

                if (!priceInput.val() || parseFloat(priceInput.val()) < 0) {
                    alert(`Vui lòng nhập giá bán hợp lệ (lớn hơn hoặc bằng 0) cho biến thể thứ ${varIndex + 1} của màu ${colorName}.`);
                    priceInput.focus();
                    variationsValid = false;
                    return false;
                }
                if (quantityInput.val() === '' || parseInt(quantityInput.val()) < 0) {
                    alert(`Vui lòng nhập số lượng tồn hợp lệ (lớn hơn hoặc bằng 0) cho biến thể thứ ${varIndex + 1} của màu ${colorName}.`);
                    quantityInput.focus();
                    variationsValid = false;
                    return false;
                }
            });

            if (!variationsValid) return false;
        });

        return variationsValid;
    }
</script>
<script th:src="@{/js/sidebar.js}" defer></script>
</body>
</html>